--SHOW TASKS LIKE 'TSK_FELICIA_H_MPB_ACUTE_FY25%';
--DESC TASK TSK_FELICIA_H_MPB_ACUTE_FY25;
select * from table(SBX_PSAS_DB.INFORMATION_SCHEMA.task_history(
    scheduled_time_range_start=>dateadd('hour',-24,current_timestamp()),
    result_limit => 10,
    task_name=>'TSK_FELICIA_H_MPB_ACUTE_FY25'));
    
--alter task TSK_FELICIA_H_MPB_ACUTE_FY25 resume; --It was by default suspended  ( run this command Only first time since by default its suspended)
execute task TSK_FELICIA_H_MPB_ACUTE_FY25;


--TASK
CREATE OR REPLACE TASK TSK_FELICIA_H_MPB_ACUTE_FY25

WAREHOUSE = SBX_EA_GENERAL_FR_WH
SCHEDULE = 'USING CRON 50 6 * * 1-5 America/Chicago' -- 6:50 AM on weekdays
TIMESTAMP_INPUT_FORMAT = 'YYYY-MM-DD HH24'
AS

-- -------------
CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.MPB_ACUTE_SECONDARY_REP_ACTUAL AS
WITH 

--IDENTIFY NEW PRODUCT LAUNCH DRUGS
NPL_LIST AS (
SELECT DISTINCT UPPER(BRAND_NAME) BRAND_NAME, MPB_LAUNCH FROM PRD_EAA_SBX_DB.MPB_SALES.T_MPB_BRAND_WITH_ADDITIONAL_ATTR WHERE MPB_LAUNCH >= '2023-04-01' AND MPB_LAUNCH <= '2025-03-31'),

--IDENTIFY EXCLUSIVE DRUGS
EXCL_LIST AS (
SELECT UPPER(BRAND_NAME) BRAND_NAME FROM PRD_EAA_SBX_DB.MPB_SALES.T_MPB_BRAND_WITH_ADDITIONAL_ATTR WHERE DISTRIBUTOR_ACCESS_CAT = 'Exclusive'),

TARGET_PREP AS (
SELECT  COPA.CUST_NUM AS CUST_ACCT_ID,
        CUST.CUST_ACCT_NAM,
        CUST.ACTIVE_CUST_IND,
        CUST.SLS_TERR_ID,
        CUST.HOME_DC_ID,
        CUST.DEA_NUM,
        CUST.ACCT_CLAS_CD,
        CUST.ACCT_CLAS_DSCR,
        CUST.CUST_BUS_TYP_DSCR,
        CUST.COMMON_ENTITY_ID,
        CUST.COMMON_ENTITY_NAME,
        CUST.COMMON_GRP_ID,
        CUST.COMMON_GRP_NAME,
        CUST.ACCT_340B_ID,
        REP.Specialty_Dist_Rep AS REP_NAME,
        -- ITEM.EM_ITEM_NUM,
        BRAND.BRND_NAM,
        CASE WHEN EXCL.BRAND_NAME IS NOT NULL THEN 'Y' ELSE 'N' END EXCL_FLAG,
        CASE WHEN NPL.BRAND_NAME IS NOT NULL THEN 'Y' ELSE 'N' END NPL_FLAG,
        CASE WHEN CUST.CNTRCT_PHARM_ACCT_FLG = 'Y' THEN 'Y' ELSE 'N' END CNTRCT_PHARM_FLAG,
        SUM(CASE WHEN POST_DT BETWEEN '2023-10-01' AND '2024-03-31' THEN (GROSS_SLS + RTRN) ELSE 0 END)/6 AS "NET_SLS_TARGET_PREP",
        SUM(CASE WHEN POST_DT BETWEEN '2023-10-01' AND '2024-03-31' THEN GROSS_PROFIT ELSE 0 END)/6 AS "GROSS_PROFIT_TARGET_PREP" 
FROM    "SBX_PSAS_DB"."SBX_EA_ALL"."V_COPA_EA" COPA
JOIN    PRD_PSAS_DB.EDWRPT.DIM_CUST_ACCT_CURR CUST
ON      LTRIM(COPA.CUST_NUM,'0') = LTRIM(CUST.CUST_ACCT_ID,'0')
JOIN    SBX_PSAS_DB.SALES_OPS_GOV.MPB_ACUTE_SECONDARY_REP REP --SECONDARY REP ONLY
ON      LTRIM(COPA.CUST_NUM,'0') = LTRIM(REP.Customer_No,'0')
JOIN    PRD_PSAS_DB.RPT.DIM_ITEM_CURR ITEM
ON      LTRIM(COPA.MTRL_NUM,'0') = LTRIM(ITEM.EM_ITEM_NUM,'0')
JOIN    PRD_PSAS_DB.RPT.T_NDC BRAND --BRAND TABLE
ON      LTRIM(ITEM.NDC_CD,0) = LTRIM(BRAND.NDC_NUM,0)
LEFT JOIN    NPL_LIST NPL
ON      BRAND.BRND_NAM = NPL.BRAND_NAME
LEFT JOIN    EXCL_LIST EXCL
ON      BRAND.BRND_NAM = EXCL.BRAND_NAME
WHERE   EXCL.BRAND_NAME IS NULL --EXCLUDE EXCL
AND     NPL.BRAND_NAME IS NULL --EXCLUDE NPL
AND     COPA.CMPNY_CD IN ('8545') -- MPB ONLY
AND     POST_DT BETWEEN '2023-10-01' AND '2024-03-31'
AND     CUST.ACTIVE_CUST_IND = 'A'
AND     CUST.CNTRCT_PHARM_ACCT_FLG <> 'Y' --Exclude Contract Pharmacies 
AND     REP.Primary_Secondary = 'SECONDARY'
GROUP BY COPA.CUST_NUM,
        CUST.CUST_ACCT_NAM,
        CUST.ACTIVE_CUST_IND,
        CUST.SLS_TERR_ID,
        CUST.HOME_DC_ID,
        CUST.DEA_NUM,
        CUST.ACCT_CLAS_CD,
        CUST.ACCT_CLAS_DSCR,
        CUST.CUST_BUS_TYP_DSCR,
        CUST.COMMON_ENTITY_ID,
        CUST.COMMON_ENTITY_NAME,
        CUST.COMMON_GRP_ID,
        CUST.COMMON_GRP_NAME,
        CUST.ACCT_340B_ID,
        REP.Specialty_Dist_Rep, --REP_NAME
        -- ITEM.EM_ITEM_NUM,
        BRAND.BRND_NAM,
        CASE WHEN EXCL.BRAND_NAME IS NOT NULL THEN 'Y' ELSE 'N' END,
        CASE WHEN NPL.BRAND_NAME IS NOT NULL THEN 'Y' ELSE 'N' END,
        CASE WHEN CUST.CNTRCT_PHARM_ACCT_FLG = 'Y' THEN 'Y' ELSE 'N' END),

TARGET AS (
SELECT *,
CASE WHEN NET_SLS_TARGET_PREP<=0 AND GROSS_PROFIT_TARGET_PREP<=0 THEN 0
     ELSE NET_SLS_TARGET_PREP END AS NET_SLS_TARGET,
CASE WHEN GROSS_PROFIT_TARGET_PREP<=0 AND NET_SLS_TARGET_PREP<=0 THEN 0
     ELSE GROSS_PROFIT_TARGET_PREP END AS GROSS_PROFIT_TARGET
FROM TARGET_PREP),

MPB_ACUTE_SECONDARY_REP_TARGET AS (
SELECT *,'2024-04' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2024-05' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2024-06' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2024-07' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2024-08' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2024-09' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2024-10' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2024-11' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2024-12' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2025-01' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2025-02' AS CAL_YR_PERIOD
FROM TARGET
UNION 
SELECT *,'2025-03' AS CAL_YR_PERIOD
FROM TARGET),

ACTUAL AS (
SELECT  COPA.CUST_NUM AS CUST_ACCT_ID,
        CUST.CUST_ACCT_NAM,
        CUST.ACTIVE_CUST_IND,
        CUST.SLS_TERR_ID,
        CUST.HOME_DC_ID,
        CUST.DEA_NUM,
        CUST.ACCT_CLAS_CD,
        CUST.ACCT_CLAS_DSCR,
        CUST.CUST_BUS_TYP_DSCR,
        CUST.COMMON_ENTITY_ID,
        CUST.COMMON_ENTITY_NAME,
        CUST.COMMON_GRP_ID,
        CUST.COMMON_GRP_NAME,
        CUST.ACCT_340B_ID,
        REP.Specialty_Dist_Rep AS REP_NAME,
        -- ITEM.EM_ITEM_NUM,
        BRAND.BRND_NAM,
        CASE WHEN EXCL.BRAND_NAME IS NOT NULL THEN 'Y' ELSE 'N' END EXCL_FLAG,
        CASE WHEN NPL.BRAND_NAME IS NOT NULL THEN 'Y' ELSE 'N' END NPL_FLAG,
        CASE WHEN CUST.CNTRCT_PHARM_ACCT_FLG = 'Y' THEN 'Y' ELSE 'N' END CNTRCT_PHARM_FLAG,
        COPA.CAL_YR_PERIOD,
        SUM(GROSS_SLS + RTRN) AS NET_SLS_ACTUAL,
        SUM(GROSS_PROFIT) AS GROSS_PROFIT_ACTUAL 
FROM    "SBX_PSAS_DB"."SBX_EA_ALL"."V_COPA_EA" COPA
JOIN    PRD_PSAS_DB.EDWRPT.DIM_CUST_ACCT_CURR CUST
ON      LTRIM(COPA.CUST_NUM,'0') = LTRIM(CUST.CUST_ACCT_ID,'0')
JOIN    SBX_PSAS_DB.SALES_OPS_GOV.MPB_ACUTE_SECONDARY_REP REP --SECONDARY REP ONLY
ON      LTRIM(COPA.CUST_NUM,'0') = LTRIM(REP.Customer_No,'0')
JOIN    PRD_PSAS_DB.RPT.DIM_ITEM_CURR ITEM
ON      LTRIM(COPA.MTRL_NUM,'0') = LTRIM(ITEM.EM_ITEM_NUM,'0')
JOIN    PRD_PSAS_DB.RPT.T_NDC BRAND --BRAND TABLE
ON      LTRIM(ITEM.NDC_CD,0) = LTRIM(BRAND.NDC_NUM,0)
LEFT JOIN    NPL_LIST NPL
ON      BRAND.BRND_NAM = NPL.BRAND_NAME
LEFT JOIN    EXCL_LIST EXCL
ON      BRAND.BRND_NAM = EXCL.BRAND_NAME
WHERE   EXCL.BRAND_NAME IS NULL --EXCLUDE EXCL
AND     NPL.BRAND_NAME IS NULL --EXCLUDE NPL
AND     COPA.CMPNY_CD IN ('8545') -- MPB ONLY
AND     POST_DT BETWEEN '2024-04-01' AND '2025-03-31'
AND     CUST.ACTIVE_CUST_IND = 'A'
AND     CUST.CNTRCT_PHARM_ACCT_FLG <> 'Y' --Exclude Contract Pharmacies 
AND     REP.Primary_Secondary = 'SECONDARY'
GROUP BY COPA.CUST_NUM,
        CUST.CUST_ACCT_NAM,
        CUST.ACTIVE_CUST_IND,
        CUST.SLS_TERR_ID,
        CUST.HOME_DC_ID,
        CUST.DEA_NUM,
        CUST.ACCT_CLAS_CD,
        CUST.ACCT_CLAS_DSCR,
        CUST.CUST_BUS_TYP_DSCR,
        CUST.COMMON_ENTITY_ID,
        CUST.COMMON_ENTITY_NAME,
        CUST.COMMON_GRP_ID,
        CUST.COMMON_GRP_NAME,
        CUST.ACCT_340B_ID,
        REP.Specialty_Dist_Rep, --REP_NAME
        -- ITEM.EM_ITEM_NUM,
        BRAND.BRND_NAM,
        CASE WHEN EXCL.BRAND_NAME IS NOT NULL THEN 'Y' ELSE 'N' END,
        CASE WHEN NPL.BRAND_NAME IS NOT NULL THEN 'Y' ELSE 'N' END,
        CASE WHEN CUST.CNTRCT_PHARM_ACCT_FLG = 'Y' THEN 'Y' ELSE 'N' END,
        COPA.CAL_YR_PERIOD),
        
FINAL_PREP1 AS (
SELECT  TARGET.CUST_ACCT_ID,
        TARGET.CUST_ACCT_NAM,
        TARGET.ACTIVE_CUST_IND,
        TARGET.SLS_TERR_ID,
        TARGET.HOME_DC_ID,
        TARGET.DEA_NUM,
        TARGET.ACCT_CLAS_CD,
        TARGET.ACCT_CLAS_DSCR,
        TARGET.CUST_BUS_TYP_DSCR,
        TARGET.COMMON_ENTITY_ID,
        TARGET.COMMON_ENTITY_NAME,
        TARGET.COMMON_GRP_ID,
        TARGET.COMMON_GRP_NAME,
        TARGET.ACCT_340B_ID,
        TARGET.REP_NAME,
        TARGET.BRND_NAM,
        TARGET.EXCL_FLAG,
        TARGET.NPL_FLAG,
        TARGET.CNTRCT_PHARM_FLAG,
        TARGET.CAL_YR_PERIOD,
        TARGET.NET_SLS_TARGET,
        TARGET.GROSS_PROFIT_TARGET,
        ACTUAL.NET_SLS_ACTUAL,
        ACTUAL.GROSS_PROFIT_ACTUAL
FROM MPB_ACUTE_SECONDARY_REP_TARGET TARGET
LEFT JOIN ACTUAL ACTUAL
ON LTRIM(TARGET.CUST_ACCT_ID,'0')=LTRIM(ACTUAL.CUST_ACCT_ID,'0')
AND TARGET.BRND_NAM=ACTUAL.BRND_NAM
AND TARGET.CAL_YR_PERIOD=ACTUAL.CAL_YR_PERIOD),

FINAL_PREP2 AS ( 
SELECT ACTUAL.CUST_ACCT_ID,
        ACTUAL.CUST_ACCT_NAM,
        ACTUAL.ACTIVE_CUST_IND,
        ACTUAL.SLS_TERR_ID,
        ACTUAL.HOME_DC_ID,
        ACTUAL.DEA_NUM,
        ACTUAL.ACCT_CLAS_CD,
        ACTUAL.ACCT_CLAS_DSCR,
        ACTUAL.CUST_BUS_TYP_DSCR,
        ACTUAL.COMMON_ENTITY_ID,
        ACTUAL.COMMON_ENTITY_NAME,
        ACTUAL.COMMON_GRP_ID,
        ACTUAL.COMMON_GRP_NAME,
        ACTUAL.ACCT_340B_ID,
        ACTUAL.REP_NAME,
        ACTUAL.BRND_NAM,
        ACTUAL.EXCL_FLAG,
        ACTUAL.NPL_FLAG,
        ACTUAL.CNTRCT_PHARM_FLAG,
        ACTUAL.CAL_YR_PERIOD,
        TARGET.NET_SLS_TARGET,
        TARGET.GROSS_PROFIT_TARGET,
        ACTUAL.NET_SLS_ACTUAL,
        ACTUAL.GROSS_PROFIT_ACTUAL
FROM ACTUAL ACTUAL
LEFT JOIN MPB_ACUTE_SECONDARY_REP_TARGET TARGET
ON LTRIM(TARGET.CUST_ACCT_ID,'0')=LTRIM(ACTUAL.CUST_ACCT_ID,'0')
AND TARGET.BRND_NAM=ACTUAL.BRND_NAM
AND TARGET.CAL_YR_PERIOD=ACTUAL.CAL_YR_PERIOD),

FINAL AS (
SELECT * FROM FINAL_PREP1
UNION
SELECT * FROM FINAL_PREP2)

SELECT  CUST_ACCT_ID,
        CUST_ACCT_NAM,
        ACTIVE_CUST_IND,
        SLS_TERR_ID,
        HOME_DC_ID,
        DEA_NUM,
        ACCT_CLAS_CD,
        ACCT_CLAS_DSCR,
        CUST_BUS_TYP_DSCR,
        COMMON_ENTITY_ID,
        COMMON_ENTITY_NAME,
        COMMON_GRP_ID,
        COMMON_GRP_NAME,
        ACCT_340B_ID,
        REP_NAME,
        BRND_NAM,
        EXCL_FLAG,
        NPL_FLAG,
        CNTRCT_PHARM_FLAG,
        CAL_YR_PERIOD,
        'NET SALES' AS VARIABLE,
        NET_SLS_TARGET AS TARGET,
        NET_SLS_ACTUAL AS ACTUAL
FROM FINAL
UNION
SELECT  CUST_ACCT_ID,
        CUST_ACCT_NAM,
        ACTIVE_CUST_IND,
        SLS_TERR_ID,
        HOME_DC_ID,
        DEA_NUM,
        ACCT_CLAS_CD,
        ACCT_CLAS_DSCR,
        CUST_BUS_TYP_DSCR,
        COMMON_ENTITY_ID,
        COMMON_ENTITY_NAME,
        COMMON_GRP_ID,
        COMMON_GRP_NAME,
        ACCT_340B_ID,
        REP_NAME,
        BRND_NAM,
        EXCL_FLAG,
        NPL_FLAG,
        CNTRCT_PHARM_FLAG,
        CAL_YR_PERIOD,
        'GROSS PROFIT' AS VARIABLE,
        GROSS_PROFIT_TARGET AS TARGET,
        GROSS_PROFIT_ACTUAL AS ACTUAL
FROM FINAL
